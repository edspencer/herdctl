---
phase: 01-runtime-abstraction-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/runner/runtime/index.ts
  - packages/core/src/runner/runtime/interface.ts
  - packages/core/src/runner/runtime/sdk-runtime.ts
  - packages/core/src/runner/runtime/factory.ts
autonomous: true

must_haves:
  truths:
    - "RuntimeInterface defines execute() returning AsyncIterable<SDKMessage>"
    - "SDKRuntime wraps SDK query() behind RuntimeInterface"
    - "RuntimeFactory creates SDKRuntime when runtime type is 'sdk' or undefined"
    - "RuntimeFactory throws clear error for 'cli' runtime (not yet implemented)"
  artifacts:
    - path: "packages/core/src/runner/runtime/interface.ts"
      provides: "RuntimeInterface and RuntimeExecuteOptions types"
      exports: ["RuntimeInterface", "RuntimeExecuteOptions"]
    - path: "packages/core/src/runner/runtime/sdk-runtime.ts"
      provides: "SDKRuntime adapter implementation"
      exports: ["SDKRuntime"]
    - path: "packages/core/src/runner/runtime/factory.ts"
      provides: "RuntimeFactory for runtime instantiation"
      exports: ["RuntimeFactory", "RuntimeType"]
    - path: "packages/core/src/runner/runtime/index.ts"
      provides: "Runtime module barrel export"
      exports: ["RuntimeInterface", "RuntimeExecuteOptions", "SDKRuntime", "RuntimeFactory", "RuntimeType"]
  key_links:
    - from: "packages/core/src/runner/runtime/sdk-runtime.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "import { query }"
      pattern: "import.*query.*from.*claude-agent-sdk"
    - from: "packages/core/src/runner/runtime/sdk-runtime.ts"
      to: "packages/core/src/runner/sdk-adapter.ts"
      via: "import { toSDKOptions }"
      pattern: "import.*toSDKOptions.*from.*sdk-adapter"
    - from: "packages/core/src/runner/runtime/factory.ts"
      to: "packages/core/src/runner/runtime/sdk-runtime.ts"
      via: "new SDKRuntime()"
      pattern: "new SDKRuntime"
---

<objective>
Create the runtime abstraction layer with RuntimeInterface, SDKRuntime adapter, and RuntimeFactory.

Purpose: Establish the foundation for supporting multiple Claude execution backends (SDK and CLI) through a unified interface. This decouples JobExecutor from direct SDK dependency.

Output: New `runtime/` directory with interface definition, SDK adapter, and factory for runtime selection.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-runtime-abstraction-foundation/01-RESEARCH.md
@packages/core/src/runner/types.ts
@packages/core/src/runner/sdk-adapter.ts
@packages/core/src/runner/job-executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RuntimeInterface and types</name>
  <files>packages/core/src/runner/runtime/interface.ts</files>
  <action>
Create the RuntimeInterface definition with RuntimeExecuteOptions.

The interface must:
1. Define `RuntimeInterface` with single `execute(options: RuntimeExecuteOptions): AsyncIterable<SDKMessage>` method
2. Define `RuntimeExecuteOptions` interface with:
   - `prompt: string` - The prompt to execute
   - `agent: ResolvedAgent` - Resolved agent configuration
   - `resume?: string` - Optional session ID to resume
   - `fork?: boolean` - Whether to fork the session
   - `abortController?: AbortController` - For cancellation support

Import `SDKMessage` from `../types.js` and `ResolvedAgent` from `../../config/index.js`.

Use JSDoc comments explaining the interface contract. The interface returns AsyncIterable because SDK already uses this pattern.

Do NOT use abstract classes - pure interface is lighter and avoids inheritance issues.
  </action>
  <verify>TypeScript compiles: `cd packages/core && pnpm exec tsc --noEmit src/runner/runtime/interface.ts`</verify>
  <done>interface.ts exports RuntimeInterface and RuntimeExecuteOptions types</done>
</task>

<task type="auto">
  <name>Task 2: Implement SDKRuntime adapter</name>
  <files>packages/core/src/runner/runtime/sdk-runtime.ts</files>
  <action>
Create SDKRuntime class implementing RuntimeInterface.

Implementation requirements:
1. Import `query` from `@anthropic-ai/claude-agent-sdk`
2. Import `toSDKOptions` from `../sdk-adapter.js`
3. Import `RuntimeInterface`, `RuntimeExecuteOptions` from `./interface.js`
4. Import `SDKMessage` from `../types.js`

The `execute` method must:
1. Use `async *execute()` generator function syntax (NOT async function returning Promise)
2. Call `toSDKOptions(options.agent, { resume: options.resume, fork: options.fork })`
3. Call SDK `query({ prompt, options: sdkOptions, abortController })`
4. Yield each message from the SDK query iterator
5. Cast SDK messages to SDKMessage type

CRITICAL: Ensure abortController is passed through to SDK query() for job cancellation support.

Pattern from research:
```typescript
export class SDKRuntime implements RuntimeInterface {
  async *execute(options: RuntimeExecuteOptions): AsyncIterable<SDKMessage> {
    const sdkOptions = toSDKOptions(options.agent, {
      resume: options.resume,
      fork: options.fork,
    });

    const messages = query({
      prompt: options.prompt,
      options: sdkOptions as Record<string, unknown>,
      abortController: options.abortController,
    });

    for await (const message of messages) {
      yield message as SDKMessage;
    }
  }
}
```
  </action>
  <verify>TypeScript compiles: `cd packages/core && pnpm exec tsc --noEmit src/runner/runtime/sdk-runtime.ts`</verify>
  <done>SDKRuntime implements RuntimeInterface and delegates to SDK query()</done>
</task>

<task type="auto">
  <name>Task 3: Implement RuntimeFactory and exports</name>
  <files>
packages/core/src/runner/runtime/factory.ts
packages/core/src/runner/runtime/index.ts
  </files>
  <action>
Create RuntimeFactory class and barrel export for the runtime module.

**factory.ts requirements:**
1. Define `RuntimeType = 'sdk' | 'cli'` type
2. Create `RuntimeFactory` class with static `create(agent: ResolvedAgent): RuntimeInterface` method
3. Get runtime type from `agent.runtime ?? 'sdk'` (default to SDK)
4. For 'sdk': return `new SDKRuntime()`
5. For 'cli': throw `new Error('CLI runtime not yet implemented (coming in Phase 2)')`
6. For unknown: throw `new Error('Unknown runtime type: ${runtimeType}')`

Import `ResolvedAgent` from `../../config/index.js`.

**index.ts requirements:**
Export all public types and classes:
```typescript
export type { RuntimeInterface, RuntimeExecuteOptions } from "./interface.js";
export { SDKRuntime } from "./sdk-runtime.js";
export { RuntimeFactory, type RuntimeType } from "./factory.js";
```

This provides clean imports: `import { RuntimeInterface, RuntimeFactory } from "./runtime/index.js"`
  </action>
  <verify>
Both files compile: `cd packages/core && pnpm exec tsc --noEmit src/runner/runtime/factory.ts src/runner/runtime/index.ts`
  </verify>
  <done>RuntimeFactory creates SDKRuntime for 'sdk' type, throws for 'cli', and runtime module has barrel export</done>
</task>

</tasks>

<verification>
1. All new files exist in packages/core/src/runner/runtime/
2. TypeScript compilation succeeds: `cd packages/core && pnpm typecheck`
3. No direct SDK imports outside of sdk-runtime.ts: `grep -r "@anthropic-ai/claude-agent-sdk" packages/core/src/runner/runtime/ | grep -v sdk-runtime.ts` returns empty
4. RuntimeFactory.create({} as any) with runtime: undefined returns SDKRuntime instance
</verification>

<success_criteria>
- RuntimeInterface defines execute() returning AsyncIterable<SDKMessage>
- SDKRuntime wraps SDK query() and passes through abortController
- RuntimeFactory creates SDKRuntime when runtime is 'sdk' or undefined
- RuntimeFactory throws clear error for 'cli' (Phase 2 work)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-runtime-abstraction-foundation/01-01-SUMMARY.md`
</output>
