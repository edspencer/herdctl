---
phase: 02-cli-runtime-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/package.json
  - packages/core/src/runner/runtime/cli-output-parser.ts
  - packages/core/src/runner/runtime/cli-session-path.ts
autonomous: true

must_haves:
  truths:
    - "CLI stream-json output can be parsed to SDKMessage format"
    - "Workspace paths can be encoded to CLI session directory format"
    - "Session directory paths can be constructed from workspace paths"
  artifacts:
    - path: "packages/core/src/runner/runtime/cli-output-parser.ts"
      provides: "CLI to SDKMessage transformation"
      exports: ["toSDKMessage", "CLIMessage"]
    - path: "packages/core/src/runner/runtime/cli-session-path.ts"
      provides: "Session path encoding utilities"
      exports: ["encodePathForCli", "getCliSessionDir"]
  key_links:
    - from: "cli-output-parser.ts"
      to: "SDKMessage type"
      via: "import from ../types.js"
      pattern: "import.*SDKMessage.*from.*types"
---

<objective>
Install CLI runtime dependencies and create foundation utilities for CLIRuntime implementation.

Purpose: Provide the building blocks (output parser, session paths) that CLIRuntime will use to transform CLI output to SDK format and locate session files.

Output: execa and chokidar installed; cli-output-parser.ts and cli-session-path.ts created with tested utility functions.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-runtime-implementation/02-RESEARCH.md
@packages/core/src/runner/runtime/interface.ts
@packages/core/src/runner/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install execa and chokidar dependencies</name>
  <files>packages/core/package.json</files>
  <action>
Install the required dependencies for CLI runtime:

```bash
pnpm add execa@^9 chokidar@^5 --filter @herdctl/core
```

Verify both packages are added to dependencies in package.json:
- execa: ^9.x (process spawning with AbortController support)
- chokidar: ^5.x (file watching with awaitWriteFinish)

Do NOT install @types packages - both libraries include TypeScript definitions.
  </action>
  <verify>
- `pnpm install` completes without errors
- `grep -E "execa|chokidar" packages/core/package.json` shows both dependencies
- `pnpm build --filter @herdctl/core` compiles successfully
  </verify>
  <done>
execa ^9.x and chokidar ^5.x appear in packages/core/package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI output parser</name>
  <files>packages/core/src/runner/runtime/cli-output-parser.ts</files>
  <action>
Create cli-output-parser.ts that transforms Claude CLI stream-json output to SDKMessage format.

The CLI outputs JSONL with these message types (from research):
- `{"type":"system","subtype":"init","session_id":"...","cwd":"...","tools":[...],"model":"..."}`
- `{"type":"assistant","message":{...},"session_id":"..."}`
- `{"type":"result","subtype":"success|error","is_error":boolean,"result":"...","session_id":"..."}`
- `{"type":"user","message":{...},"session_id":"..."}`

Implementation requirements:
1. Define CLIMessage interface for CLI output types
2. Create toSDKMessage(cliMessage: CLIMessage): SDKMessage function
3. Handle message type mapping:
   - system: Copy type, subtype, session_id
   - assistant: Extract content from message.content[0].text if present
   - result: Map subtype, result, preserve session_id
   - user: Pass through with message content
   - Default: Spread remaining fields for unknown types

4. Create parseCLILine(line: string): SDKMessage | null function
   - Skip empty lines
   - Try JSON.parse, return null on error (log warning)
   - Call toSDKMessage on parsed object

Export: CLIMessage, toSDKMessage, parseCLILine

Reference SDKMessage from ../types.js for type compatibility.
  </action>
  <verify>
- `pnpm build --filter @herdctl/core` compiles successfully
- `grep -E "export.*toSDKMessage|export.*parseCLILine" packages/core/src/runner/runtime/cli-output-parser.ts` shows exports
  </verify>
  <done>
cli-output-parser.ts exists with toSDKMessage() and parseCLILine() functions that transform CLI output to SDKMessage format
  </done>
</task>

<task type="auto">
  <name>Task 3: Create session path utilities</name>
  <files>packages/core/src/runner/runtime/cli-session-path.ts</files>
  <action>
Create cli-session-path.ts with utilities for locating Claude CLI session files.

The CLI encodes workspace paths by replacing slashes with hyphens (from research):
- `/Users/ed/Code/myproject` -> `-Users-ed-Code-myproject`
- Session files stored at: `~/.claude/projects/{encoded}/`

Implementation requirements:
1. Create encodePathForCli(absolutePath: string): string
   - Replace all `/` with `-`
   - Works on both Unix and Windows paths (also replace `\`)

2. Create getCliSessionDir(workspacePath: string): string
   - Encode the workspace path
   - Return `path.join(os.homedir(), '.claude', 'projects', encoded)`

3. Create getCliSessionFile(workspacePath: string, sessionId: string): string
   - Get session dir
   - Return path to specific session JSONL file
   - Format: `{sessionDir}/{sessionId}.jsonl`

Export: encodePathForCli, getCliSessionDir, getCliSessionFile

Use Node.js built-ins: path, os. No additional dependencies needed.
  </action>
  <verify>
- `pnpm build --filter @herdctl/core` compiles successfully
- `grep -E "export.*encodePathForCli|export.*getCliSessionDir" packages/core/src/runner/runtime/cli-session-path.ts` shows exports
  </verify>
  <done>
cli-session-path.ts exists with path encoding functions for locating CLI session files
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pnpm build --filter @herdctl/core` passes
2. `pnpm typecheck --filter @herdctl/core` passes
3. Both utility files export their functions
4. Dependencies installed correctly
</verification>

<success_criteria>
- execa ^9.x and chokidar ^5.x in package.json
- cli-output-parser.ts transforms CLI messages to SDKMessage
- cli-session-path.ts encodes paths and locates session directories
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-runtime-implementation/02-01-SUMMARY.md`
</output>
