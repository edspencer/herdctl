---
date: 2026-02-20
audit_type: incremental
scanner_status: FAIL
overall_result: WARN
commits_analyzed: 40
new_findings: 1
resolved_findings: 0
---

# Security Intelligence Report - 2026-02-20

**Date:** 2026-02-20
**Audit Type:** Incremental (since 2026-02-17)
**Overall Result:** WARN
**Auditor:** security-audit-orchestrator

---

## Executive Summary

Incremental audit covering 40 commits since last audit (b337721 - 2026-02-15). This audit period saw major feature additions including @herdctl/web dashboard, @herdctl/chat shared infrastructure, enhanced Slack integration, and OAuth token refresh functionality. The audit focused on:

1. Running deterministic scanner across all hot spots (Phase 1)
2. Analyzing 40 commits for security-relevant changes (Phase 2)
3. Hot spot verification on container-manager.ts (modified)
4. Assessment of new authentication/authorization code paths

**Scanner Result:** FAIL (3 HIGH findings in docker-config hot spots - pre-existing accepted risks)
**Changes Risk:** MEDIUM (OAuth token handling added to container-manager.ts)
**New Finding:** #011 - OAuth token refresh adds filesystem credential handling to container-manager.ts

---

## Phase 1: Deterministic Scanner Results

**Scanner Status: FAIL**
**Duration:** 2273ms
**Checks Run:** 6

| Check | Status | Findings | Details |
|-------|--------|----------|---------|
| npm-audit | WARN | 1 | 2 moderate vulnerabilities in dependencies |
| docker-config | FAIL | 3 | hostConfigOverride bypass warnings (pre-existing #002) |
| permission-modes | WARN | 1 | bypassPermissions in example config (expected) |
| subprocess-patterns | WARN | 4 | child_process usage, shell:true (pre-existing #006, #009) |
| path-safety | PASS | 0 | buildSafeFilePath in place |
| env-handling | PASS | 0 | Interpolation safe |

**Scanner findings summary:**

### FAIL: docker-config (3 HIGH findings - pre-existing #002)

All three findings are for `hostConfigOverride` in:
- `packages/core/src/runner/runtime/docker-config.ts:260`
- `packages/core/src/runner/runtime/container-manager.ts:146`
- `packages/core/src/runner/runtime/container-manager.ts:147`

**Status:** ACCEPTED RISK (#002) - Required for fleet-level advanced Docker configs. Agent-level schema uses `.strict()` to reject overrides.

### WARN: permission-modes (1 LOW finding)

bypassPermissions used in `examples/bragdoc-developer/agents/developer.yaml:47`

**Status:** EXPECTED - Example config demonstrating feature; includes Docker isolation note.

### WARN: subprocess-patterns (4 findings)

- 2 LOW: Direct child_process imports (shell.ts, sessions.ts)
- 2 MEDIUM: shell:true usage (shell.ts:154, sessions.ts:415)

**Status:** PRE-EXISTING (#006 shell hook, #009 tech debt)

### WARN: npm-audit (1 MEDIUM finding)

2 moderate vulnerabilities in dependencies.

**Status:** #008 MEDIUM - Manual review needed for upgrade path.

**No new scanner findings identified in this audit.**

---

## Phase 2: Changes Analysis

**Commits Since Last Audit:** 40 (b337721..5469008, 2026-02-17 to 2026-02-20)
**Files Changed:** 385 files (+47,845 insertions, -12,694 deletions)

### Major Features Added

1. **@herdctl/web Dashboard (#72)** - New package for web UI
   - Vite + React + Tailwind stack
   - Requires authentication review (future audit)
   - No immediate security concerns in core logic

2. **@herdctl/chat Shared Infrastructure (#67)** - Extracted from Discord
   - DM filtering, session management, message handling
   - No authentication changes to core

3. **Slack Integration Enhancements**
   - DM support with allowlist/blocklist (#69)
   - Per-agent model alignment (#61)
   - Shared chat infrastructure migration (#67)

4. **OAuth Token Auto-Refresh** - Added to container-manager.ts
   - NEW: Filesystem credential read/write operations
   - NEW: HTTPS token refresh to console.anthropic.com
   - NEW: Token expiry tracking and refresh logic

5. **Security Improvements**
   - #65: Secret leak prevention in audit reports
   - #66: Daily audit cleanup and agent.yaml migration

### Security-Relevant Changes

#### HIGH PRIORITY: OAuth Token Refresh in container-manager.ts

**Commits:** fd8f39d, 0953e36

**New code added:**
- `readCredentialsFile()` - Reads `~/.claude/.credentials.json`
- `writeCredentialsFile()` - Writes updated tokens back to disk
- `refreshClaudeOAuthToken()` - HTTPS POST to console.anthropic.com/v1/oauth/token
- `ensureValidOAuthToken()` - Token expiry check with 5-minute buffer
- Integration into container startup flow

**Security implications:**
1. container-manager.ts now handles sensitive credential data
2. Filesystem writes to credentials file from fleet manager process
3. HTTPS requests to Anthropic token endpoint (CLIENT_ID hardcoded)
4. Token refresh happens transparently during agent startup
5. Error handling writes to logger (potential credential leak in logs?)

**Risk Level:** MEDIUM

**Requires verification:**
- Are refresh tokens logged on error?
- Is the credentials file properly protected (0600 permissions)?
- Does the token refresh handle network failures safely?
- Are old tokens properly cleared on refresh?

**NEW FINDING #011:** OAuth token refresh adds filesystem credential management to container-manager.ts. Needs review for credential leak vectors.

#### MEDIUM PRIORITY: Slack DM Filtering (#69)

**New authentication surface:**
- DM allowlist/blocklist configuration
- User ID validation in dm-filter.ts
- No privilege escalation risk identified

**Status:** PASS - Configuration-driven access control, no code execution risk.

#### LOW PRIORITY: Verbose Logging (#53)

**Changes:** Added logger integration to container-manager.ts and other files.

**Risk:** Logging OAuth refresh operations could leak tokens if error messages include full response bodies.

**Requires verification:** Check logger.error() calls in refreshClaudeOAuthToken() for credential leaks.

### bypassPermissions Job File Growth

**Current count:** 22 files with `bypassPermissions: true` (was 21 on 2026-02-17)
**Total job YAML files:** 96 (was 86 on 2026-02-17)
**Percentage:** 22.9% (was 24.4%)

**Status:** Stable growth (+1 file in 3 days). Retention policy still needed but not urgent.

---

## Phase 3: Hot Spot Verification

### container-manager.ts (Modified - OAuth token refresh)

**Status: NEW CODE ADDED - NEEDS REVIEW**

**Changes:**
- Added imports: `fs`, `createLogger`
- Added 3 new functions for OAuth credential management
- Modified container startup to call `ensureValidOAuthToken()`

**Security review:**

1. **Credential file read (`readCredentialsFile()`):**
   ```typescript
   const credsPath = path.join(os.homedir(), ".claude", ".credentials.json");
   const creds = JSON.parse(fs.readFileSync(credsPath, "utf-8"));
   return creds.claudeAiOauth ?? null;
   ```
   - CONCERN: No file permission check (should verify 0600)
   - CONCERN: Reads from user homedir (trusted location, but multi-user systems?)
   - PASS: Returns null on error (safe fallback)

2. **Credential file write (`writeCredentialsFile()`):**
   ```typescript
   fs.writeFileSync(credsPath, JSON.stringify(creds, null, 2));
   ```
   - CONCERN: No explicit permission set on write (should enforce 0600)
   - CONCERN: Error handling logs to logger.error - check for credential leaks
   - PASS: Merges with existing creds object (doesn't clobber file)

3. **Token refresh (`refreshClaudeOAuthToken()`):**
   ```typescript
   logger.info("Refreshing Claude OAuth token...");
   const response = await fetch(CLAUDE_OAUTH_TOKEN_URL, {...});
   ```
   - CONCERN: Log message might expose refresh timing (low risk)
   - CONCERN: Need to verify response body isn't logged on error
   - PASS: Uses HTTPS (encrypted in transit)
   - PASS: Client ID is public (9d1c250a-e61b-44d9-88ed-5944d1962f5e)
   - CONCERN: 5-minute refresh buffer (TOKEN_REFRESH_BUFFER_MS) - verify no race conditions

**Verdict:** MEDIUM risk - New credential handling code needs review for:
- File permission enforcement
- Logger calls potentially leaking tokens
- Error path security

**NEW FINDING #011 confirmed:** OAuth credential management in container-manager.ts needs security review.

### container-runner.ts (Finding #009 - shell escaping)

**Status: UNCHANGED**

Shell escaping remains incomplete at line 157 (missing `$`, backtick, `!` escapes). Still low-priority tech debt.

### docker-config.ts (Finding #002 - hostConfigOverride)

**Status: UNCHANGED**

hostConfigOverride remains at line 260. Accepted risk, fleet-level only.

### shell.ts hook runner (Finding #006 - shell:true)

**Status: UNCHANGED**

shell:true usage required for shell hooks. Accepted risk.

---

## Phase 4: New Findings Assessment

### Finding #011: OAuth Token Refresh Credential Management

**Severity:** MEDIUM
**Status:** YELLOW - Needs review
**Introduced:** Commits fd8f39d, 0953e36 (2026-02-17 to 2026-02-20)

**Description:**
container-manager.ts now reads/writes OAuth credentials from `~/.claude/.credentials.json` and refreshes tokens via HTTPS to console.anthropic.com. This adds:
1. Filesystem credential read/write operations
2. Network requests containing sensitive tokens
3. Potential logging of credential data on errors

**Security concerns:**
1. **File permissions:** No enforcement of 0600 on credentials file
2. **Logging:** logger.error() calls may leak refresh tokens in error messages
3. **Multi-user systems:** Reading from homedir may expose credentials to other users if permissions wrong
4. **Token lifecycle:** Need to verify old tokens are cleared after refresh

**Recommended actions:**
1. Add explicit `fs.chmodSync(credsPath, 0o600)` after writeCredentialsFile()
2. Review all logger calls in OAuth functions - ensure no token data in messages
3. Verify error handling doesn't expose refresh_token or access_token in logs
4. Add comment documenting that credentials file must be user-readable only

**Priority:** MEDIUM - Fix before production release; not immediately exploitable but poor credential hygiene.

---

## Phase 5: Open Questions Update

| ID | Question | Status | Update |
|----|----------|--------|--------|
| Q1 | Webhook authentication | PARTIALLY ANSWERED | secret_env in schema; server impl unclear (no change) |
| Q3 | Container name special chars | OPEN | No change |
| Q4 | Log injection via agent output | OPEN | No change |
| Q5 | Fleet/agent config merge overrides | OPEN | No change |
| Q7 | Docker container user (root?) | PARTIALLY ANSWERED | user field configurable; default = image default (no change) |
| Q8 | SDK wrapper prompt escaping | OPEN | No change |
| Q9 | Rate limiting on webhook triggers | OPEN | No change |
| Q10 | MCP server security model | OPEN | No change |
| Q11 | GitHub work source SSRF | OPEN | No change |

**No questions resolved in this audit period.**

---

## Summary

| Category | Status | Notes |
|----------|--------|-------|
| Scanner | FAIL | 3 HIGH pre-existing accepted risks (#002), 3 WARN pre-existing |
| Source Code Changes | WARN | 40 commits, major features added, OAuth token handling NEW |
| New Findings | 1 | #011 OAuth credential management - MEDIUM |
| Path Traversal | PASS | Controls verified intact |
| Command Injection | PASS | No new vectors |
| Secret Handling | WARN | OAuth tokens now handled - logging needs review |
| Container Security | UNCHANGED | hostConfigOverride (#002), user:undefined (#007) |
| Job File Retention | STABLE | 22 files (+1), retention policy still needed |
| Overall | WARN | New OAuth code needs credential hygiene review |

---

## Actions

### High Priority
None (no critical findings)

### Medium Priority
1. **NEW: Review OAuth token refresh logging** - Verify no credential leaks in error paths (#011)
2. **NEW: Add file permission enforcement** - chmod 0600 on credentials.json writes (#011)
3. **EXISTING: Implement job file retention policy** - 30-day cleanup for bypassPermissions files (#010)
4. **EXISTING: Verify webhook server implementation** - Inbound auth status (Q1)

### Low Priority
1. Set explicit user in Docker config (non-root UID:GID) for hardening (Q7)
2. Fix shell escaping in container-runner.ts:157 (#009)
3. npm audit review and dependency updates (#008)

---

**Report generated:** 2026-02-20
**Next audit:** 2026-02-27 (7 days) or after significant commits
**Baseline commit:** 5469008

