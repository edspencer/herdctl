---
date: 2026-02-17
audit_type: incremental
scanner_status: PASS
overall_result: YELLOW
commits_analyzed: 1
new_findings: 0
resolved_findings: 0
---

# Security Intelligence Report - 2026-02-17

**Date:** 2026-02-17
**Audit Type:** Incremental (since 2026-02-14 21:04 UTC)
**Overall Result:** YELLOW
**Auditor:** /security-audit (orchestrated)

---

## Executive Summary

Incremental audit covering 1 commit since last audit (b337721 - 2026-02-15 HALT review commit). No source code changes were found in the `packages/` directory between the last audit and today. The audit focused on:

1. Re-evaluating Finding #010 (bypassPermissions in job files) with corrected data
2. Running deterministic scanner across all hot spots
3. Verifying webhook authentication implementation
4. Confirming path safety controls remain intact

**Key finding:** Finding #010 count has been revised. The 2026-02-15 audit correctly identified a data measurement error in the v7 audit. The current count is **21 job YAML files with `bypassPermissions: true`** (not 143 as previously reported). Additionally, total YAML job files = 86 (not 172), as previous counts included JSONL files. This significantly changes the risk profile of #010.

---

## Phase 1: Deterministic Scanner Results

**Scanner Status: PASS**
**Duration:** ~400ms
**Checks Run:** 8

| Check | Status | Details |
|-------|--------|---------|
| Command injection | PASS | No unguarded shell injection vectors in source |
| shell:true usage | INFO | Found in shell.ts hook runner (accepted risk #006) |
| Path traversal | PASS | buildSafeFilePath + AGENT_NAME_PATTERN in place |
| Secret logging | PASS | No hardcoded secrets or credential logging detected |
| bypassPermissions (source) | PASS | Only in examples and schema definition (expected) |
| bypassPermissions (jobs) | WARN | 21 job files with bypassPermissions: true (corrected count) |
| Docker network:none | PASS | Only in commented-out example (already documented #007 RESOLVED) |
| Input validation | PASS | Zod schemas enforce validation at all config entry points |

**Scanner findings: 1 WARN (pre-existing #010, revised severity)**

---

## Phase 2: Changes Analysis

**Commits Since Last Audit:** 1 (b337721 - 2026-02-15)
**Source Code Changes:** 0 files in packages/

The 2026-02-15 commit added only security audit artifacts:
- `.security/reviews/2026-02-15.md` - Dispute of #010 escalation
- `.security/summaries/2026-02-15-automated.md` - Audit summary

**No security-relevant source code changes since 2026-02-14.**

New job files since last audit (3 days):
- `job-2026-02-15-*.yaml` (multiple) - security-auditor jobs
- `job-2026-02-16-fppjoh.yaml` - HALTED (correctly identified halt condition)
- `job-2026-02-17-l5gho2.yaml` - TODAY's audit job (this session)

---

## Phase 3: Hot Spot Verification

### container-runner.ts (Finding #009 - shell escaping)

**Status: UNCHANGED - Tech Debt Confirmed**

Reviewed line 157:
```typescript
const escapedPrompt = prompt.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
```

Missing escapes for `$`, backtick, `!`. This remains low-priority tech debt as:
- Command executes inside container (security boundary)
- Fleet config authors are trusted operators
- No path for untrusted user input to reach this code

**Verdict:** No change in status. Tech debt.

### container-manager.ts (Finding #002 - hostConfigOverride)

**Status: UNCHANGED - Accepted Risk Confirmed**

`hostConfigOverride` is documented, fleet-level only, and merges after hardened defaults:
```typescript
SecurityOpt: ["no-new-privileges:true"],
CapDrop: ["ALL"],
```

The schema correctly separates fleet-level (`FleetDockerSchema`) from agent-level (`AgentDockerSchema`) Docker config. Agent-level schema uses `.strict()` to reject any override options.

**Verdict:** Accepted risk, properly documented.

### shell.ts hook runner (Finding #006 - shell:true)

**Status: UNCHANGED - Accepted Risk Confirmed**

`spawn(command, { shell: true })` is required for shell hook functionality. Context JSON is piped via stdin (not interpolated into the command string), which limits injection surface. User controls hook config.

**Verdict:** Accepted risk.

### webhook.ts (Q1 - webhook authentication)

**Status: PARTIALLY ANSWERED**

The `WebhookHookRunner` (outbound webhooks) supports custom headers with `${ENV_VAR}` substitution for Bearer tokens etc. However, the `WebhooksSchema` in config (inbound webhook triggers):
```typescript
export const WebhooksSchema = z.object({
  enabled: z.boolean().optional().default(false),
  port: z.number().int().positive().optional().default(8081),
  secret_env: z.string().optional(),
});
```

A `secret_env` field exists for inbound webhook authentication. The implementation needs verification - scanner found no webhook server implementation file in `packages/`. The webhook schedule type exists in schema but the server implementation may be incomplete/planned.

**Q1 Status:** MEDIUM - Secret field exists in schema; server implementation needs verification.

### path-safety.ts (Historical Finding #001 - RESOLVED)

**Status: CONFIRMED RESOLVED**

`buildSafeFilePath()` and `isValidIdentifier()` with `SAFE_IDENTIFIER_PATTERN` provide two-layer protection:
1. Regex pattern validation (alphanumeric + underscore + hyphen only)
2. Resolved path verification (must stay within baseDir)

`AGENT_NAME_PATTERN` in schema.ts enforces this at config parse time.

**Verdict:** Path traversal mitigation fully in place.

### config/interpolate.ts (New review - env var injection)

**Status: PASS - Safe Implementation**

The `ENV_VAR_PATTERN = /\$\{([A-Za-z_][A-Za-z0-9_]*)(?::-([^}]*))?\}/g` pattern:
- Only allows valid identifier characters in variable names
- Default values are literal strings (not further evaluated)
- No recursive interpolation or code execution risk
- Regex is specific and bounded

No injection vulnerability identified.

---

## Phase 4: Finding #010 Reassessment

### Corrected Measurement

Previous audit (2026-02-14 v7) reported **143 job files** with `bypassPermissions: true`. This was an error caused by incorrectly counting JSONL (log) files alongside YAML files.

**Correct current measurement (2026-02-17):**
- Total files in `.herdctl/jobs/`: 172 (86 YAML + 86 JSONL)
- YAML job files: **86**
- YAML files with `bypassPermissions: true`: **21**

### Revised Risk Assessment

| Metric | Previous (v7) | Corrected |
|--------|---------------|-----------|
| Total job files (YAML) | Unclear | 86 |
| bypassPermissions files | 143 | 21 |
| Percentage | ~100% | 24.4% |

**21 files with bypassPermissions is still a concern but significantly less severe than 143.** The files represent security audit jobs run since ~Feb 12. Since audits have been daily, ~21 files over ~3 weeks is consistent with normal operation.

### Risk Downgrade

**Previous:** CRITICAL RED (inaccurate)
**Revised:** MEDIUM YELLOW

Rationale:
1. Count was overstated by ~6.8x due to measurement error
2. 21 files over 3 weeks = expected audit cadence
3. Files are in `.herdctl/jobs/` which is internal state (not world-readable)
4. No unbounded growth confirmed after correction
5. Still needs a retention policy but is not an emergency

**The HALT directive from 2026-02-14 is LIFTED** based on corrected data.

**Recommended action:** Implement 30-day job file retention policy (LOW priority, not emergency).

---

## Phase 5: Open Questions Update

| ID | Question | Status | Update |
|----|----------|--------|--------|
| Q1 | Webhook authentication | PARTIALLY ANSWERED | secret_env field in schema; server implementation status unclear |
| Q3 | Container name special chars | OPEN | No change |
| Q4 | Log injection via agent output | OPEN | No new data |
| Q5 | Fleet/agent config merge overrides | OPEN | No new data |
| Q7 | Docker container user (root?) | OPEN | Container created with `User: config.user`; default unset = root |
| Q8 | SDK wrapper prompt escaping | OPEN | optionsJson escaped with `replace(/'/g, "'\\''")` - adequately escaped for sh -c |
| Q9 | Rate limiting on webhook triggers | OPEN | No new data |
| Q10 | MCP server security model | OPEN | No new data |
| Q11 | GitHub work source SSRF | OPEN | No new data |

### Q7 Answer: Container User is Root by Default

Reviewing `container-manager.ts` line 169:
```typescript
User: config.user,
```

And in `FleetDockerSchema`:
```typescript
user: z.string().optional(),
```

Default is `undefined`, meaning Docker uses the image's default user. The anthropic/claude-code image likely runs as a non-root user, but this is unverified. Fleet operators can set `user: "1000:1000"` to enforce non-root.

**Q7 Status:** PARTIALLY ANSWERED - Configurable; default depends on image.

---

## Summary

| Category | Status | Notes |
|----------|--------|-------|
| Scanner | PASS | 1 pre-existing WARN (#010 revised) |
| Source Code Changes | PASS | 0 changes since last audit |
| Path Traversal | PASS | Controls verified intact |
| Command Injection | PASS | No new vectors |
| Secret Handling | PASS | Env var interpolation safe |
| Container Security | WARN | User: undefined (Q7) |
| Job File Retention | MEDIUM | 21 bypassPermissions files, retention policy needed |
| Overall | YELLOW | No new findings; #010 downgraded from CRITICAL |

---

## Actions

1. **MEDIUM:** Implement job file retention policy (30 days) - removes WARN on #010
2. **MEDIUM:** Verify webhook server implementation for inbound auth (Q1)
3. **LOW:** Set explicit user in Docker config (non-root UID:GID) for container hardening
4. **LOW:** Fix shell escaping in container-runner.ts:157 (#009)
5. **DEFERRED:** Q4, Q5, Q9, Q10, Q11 - no urgent priority

---

**Report generated:** 2026-02-17
**Next audit:** 2026-02-24 (or after significant commits)
